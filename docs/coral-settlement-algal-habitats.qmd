---
title: "Coral settlement in algal habitats"
author: "Martina Burgo"
date: today
date-format: "DD/MM/YYYY"
format: 
  html:
    ## Format
    theme: spacelab
    html-math-method: mathjax
    ## Table of contents
    toc: true
    toc-float: true
    ## Numbering
    number-sections: true
    number-depth: 3
    ## Layout
    fig-caption-location: "bottom"
    fig-align: "center"
    fig-width: 4
    fig-height: 4
    fig-dpi: 72
    tbl-cap-location: top
    ## Code
    code-fold: false
    code-tools: true
    code-summary: "Show the code"
    code-line-numbers: true
    code-block-border-left: "#ccc"
    highlight-style: zenburn
    ## Execution
    execute:
      echo: false
      cache: false
    ## Rendering
    embed-resources: true
crossref:
  fig-title: '**Figure**'
  fig-labels: arabic
  tbl-title: '**Table**'
  tbl-labels: arabic
engine: knitr
output_dir: "docs"
documentclass: article
fontsize: 12pt
mainfont: Arial
mathfont: LiberationMono
classoption: a4paper
---

```{r}
#| label: setup
#| include: false

knitr::opts_chunk$set(cache.lazy = FALSE,
                      tidy = "styler")
options(tinytex.engine = "xelatex")
```

# Preparations

## Load libraries

```{r}
#| label: libraries
#| output: false
#| eval: true
#| warning: false
#| message: false
#| cache: false

library(tidyverse)   #for data wrangling
library(readxl)
library(vegan)
library(stringr)
library(car)
library(brms)
library(patchwork)
library(corrplot)
library(loo)
library(tidybayes)
library(DHARMa)     #for residual diagnostics
library(rstan)      #for interfacing with STAN
library(emmeans)
library(bayestestR)
library(ggridges) 

source('../R/functions.R')
knitr::read_chunk('../R/data_analysis.R')
knitr::read_chunk('../R/multivariate_analysis.R')
```

## Load models

```{r}
#| label: loadModels

load(file = '../data/modelled/MZI1_base.RData')
load(file = '../data/modelled/MZI2_Height_broad.RData')
load(file = '../data/modelled/MZI3_Height_local.RData')
load(file = '../data/modelled/MZI4_Density.RData')
load(file = '../data/modelled/MZI5_Local_diversity.RData')
load(file = '../data/modelled/MZI6_Broad_diversity.RData')
```

## Load data
```{r}
#| label: loadData
data <- read.csv('../data/processed/multivariate_data.csv')[,-1]
```


Quick view of dataset:

```{r}
#| echo: false
#| label: quickView

recruit |> 
  dplyr::select(Total, Treatment, H_mean_broad, H_mean_local,
                D_broad, Shannon_local_cor, Shannon_local_alg,
                Shannon_broad_cor, Shannon_broad_alg, Turf_height) |>
  head()
```

# Exploratory data analysis

```{r}
#| label: EDA
#| fig-width: 6
#| fig-height: 4
#| echo: false

recruit |> 
  ggplot(aes(y = Total, x = Treatment)) +
  geom_violin() +
  geom_point(color = 'black') + 
  theme_classic() +
  theme(text = element_text(colour = 'black'), 
        axis.text = element_text(size = rel(1.2)),
        axis.title = element_text(size = rel(1.5)),
        legend.text = element_text(size = rel(1.2)),
        legend.title = element_text(size = rel(1.5))) +
  scale_y_continuous(name = 'Total recruits', n.breaks = 3)
```

# Treatments

Treatments are:

1.  T1: Control, all algae were removed

2.  T2: Canopy-forming, only canopy-forming macroalgae were left in the plots

3.  T3: Mat-forming, only mat-forming macroalgae were left in the plots

4.   T4: All algae, the plots were left untouched and presented a mixed macroalgal community

![nMDS Plot: ](../output/figures/supp_fig_1.png)

```{r ANOVA}
#| results: markup
#| eval: true

```

The nDMS plot and the ANOVA show that treatments are different.


# Model 1 - Recruits \~ Treatment


Model formula:

$$
\begin{align}
y_i &\sim{} \mathcal{Pois}(\lambda_i)\\
log(\lambda_i) &= \beta_0 + \beta X + \gamma _j\\
\gamma_j \sim{} \mathcal{N}(\sigma, \sigma_1^2)\\
\beta_0 &\sim{} \mathcal{N}(0.5, 3)\\
\beta_{1,2,3} &\sim{} \mathcal{N}(0,8)\\
\sigma_1 \sim{} \mathcal{t}(3, 0, 3)\\
\end{align}
$$
```{r MZI1Fit}
#| eval: false

```


## Model diagnostics
![](../output/figures/MZI1PriorsPosteriors.png)
- looks good

![](../output/figures/M1ZIMCMC.png)

- model converged and chains are well mixed

![](../output/figures/MZI1DHARMa.png)

Underdispersed, but underdispersion means that the model is more conservative as it adds uncertainty. This means that we could be sure of any result we find since we're using a more conservative model.


## Model investigation

![Fig 1](../output/figures/M1_Treat_fig.png)

```{r}
#| echo: false
read.delim(file = '../output/tables/MZI1Output.txt', sep = ',')
```

```{r}
#| label: M1Contrast
#| eval: false
```

```{r}
#| echo: false
read.delim(file = '../output/tables/MZI1Contrast.txt', sep = ',')
```

```{r}
recruitZI.brm |> 
  emmeans(~Treatment, type = 'link') |>
  pairs(reverse = TRUE) |>
  gather_emmeans_draws() |>
  mutate(Response = exp(.value)) |>
  summarise(median_hdci(Response),
            ROPE = rope(Response, range = c(0.9, 1.1))$ROPE_Percentage)
```

## Planned contrasts

We're going to compare specific groups:

1.  No algae/Only mat vs All algae/Only canopy
2.  No algae vs Any algae
3.  Mat vs Any algae
4.  No algae vs All algae/Only canopy
5.  Canopy vs Any algae

To find the groups:

|     | "Mat" vs "Canopy" | No algae vs Any algae | Mat vs Any algae | No algae vs "Canopy" | Canopy vs Any algae |
|------------|------------|------------|------------|------------|------------|
| T1  | 1/2               | 1                     | 0                | 1                    | 0                   |
| T2  | -1/2              | -1/3                  | -1/2             | -1/2                 | -1                  |
| T3  | 1/2               | -1/3                  | 1                | 0                    | 1/2                 |
| T4  | -1/2              | -1/3                  | -1/2             | -1/2                 | 1/2                 |

```{r}
#| label: PlannedContrast
#| eval: false
```

```{r}
#| echo: false
read.delim(file = '../output/tables/MZI1PlannedContrast.txt', sep = ',')
```

![](../output/figures/MZI1_Planned_contrast_fig.png)

# M2-3: Recruits \~ *Sargassum* height + Coral richness + Algal richness

::: panel-tabset
## Model 2 - quadrats

Model formula:

$$
\begin{align}
y_i &\sim{} \mathcal{Pois}(\lambda_i)\\
ln(\mu_i) &= \boldsymbol{\beta} \bf{X_i}\\
\beta_0 &\sim{} \mathcal{N}(0.5, 10)\\
\beta_{1} &\sim{} \mathcal{N}(6,5)\\
\end{align}
$$

### Output

```{r}
#| label: M2Output
#| eval: false
```

```{r}
#| echo: false
read.delim(file = '../output/tables/M2Output.txt', sep = ',')
```

## Model 3 - perimeter

Model formula:

$$
\begin{align}
y_i &\sim{} \mathcal{Pois}(\lambda_i)\\
ln(\mu_i) &= \boldsymbol{\beta} \bf{X_i}\\
\beta_0 &\sim{} \mathcal{N}(0.5, 10)\\
\beta_{1} &\sim{} \mathcal{N}(6,8)\\
\end{align}
$$

### Output

```{r}
#| label: M3Output
#| eval: false
```

```{r}
#| echo: false
read.delim(file = '../output/tables/M3Output.txt', sep = ',')
```
:::

## Compare quadrat vs perimeter

```{r}
#| label: CompareM2vsM3
#| eval: false
```

# Model 4 - Recruits \~ *Sargassum* density

Model formula:

$$
\begin{align}
y_i &\sim{} \mathcal{Pois}(\lambda_i)\\
ln(\mu_i) &= \boldsymbol{\beta} \bf{X_i}\\
\beta_0 &\sim{} \mathcal{N}(0.5, 10)\\
\beta_{1} &\sim{} \mathcal{N}(1,3)\\
\end{align}
$$

## Output

```{r}
#| label: M4Output
#| eval: false
```

```{r}
#| echo: false
read.delim(file = '../output/tables/M4Output.txt', sep = ',')
```

# Model 5 - Recruits \~ Diversity (local)

Model formula:

$$
\begin{align}
y_i &\sim{} \mathcal{Pois}(\lambda_i)\\
ln(\mu_i) &= \boldsymbol{\beta} \bf{X_i}\\
\beta_0 &\sim{} \mathcal{N}(0.5, 10)\\
\beta_{1,2} &\sim{} \mathcal{N}(1,2)\\
\end{align}
$$

## Output

```{r}
#| label: M7Output
#| eval: false
```

```{r}
#| echo: false
read.delim(file = '../output/tables/M5Output.txt', sep = ',')
```

# Model 6 - Recruits \~ Diversity (broad)

Model formula:

$$
\begin{align}
y_i &\sim{} \mathcal{Pois}(\lambda_i)\\
ln(\mu_i) &= \boldsymbol{\beta} \bf{X_i}\\
\beta_0 &\sim{} \mathcal{N}(0.5, 10)\\
\beta_{1} &\sim{} \mathcal{N}(15, 20)\\
\end{align}
$$

## Output

```{r}
#| label: M14Output
#| eval: false
```

```{r}
#| echo: false
read.delim(file = '../output/tables/M6Output.txt', sep = ',')
```
