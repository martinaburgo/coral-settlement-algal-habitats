---
title: "Coral settlement in algal habitats"
author: "Martina Burgo"
date: today
date-format: "DD/MM/YYYY"
format: 
  html:
    ## Format
    theme: spacelab
    html-math-method: mathjax
    ## Table of contents
    toc: true
    toc-float: true
    ## Numbering
    number-sections: true
    number-depth: 3
    ## Layout
    fig-caption-location: "bottom"
    fig-align: "center"
    fig-width: 4
    fig-height: 4
    fig-dpi: 72
    tbl-cap-location: top
    ## Code
    code-fold: false
    code-tools: true
    code-summary: "Show the code"
    code-line-numbers: true
    code-block-border-left: "#ccc"
    highlight-style: zenburn
    ## Execution
    execute:
      echo: true
      cache: true
    ## Rendering
    embed-resources: true
crossref:
  fig-title: '**Figure**'
  fig-labels: arabic
  tbl-title: '**Table**'
  tbl-labels: arabic
engine: knitr
output_dir: "docs"
documentclass: article
fontsize: 12pt
mainfont: Arial
mathfont: LiberationMono
classoption: a4paper
---

```{r}
#| label: setup
#| include: false

knitr::opts_chunk$set(cache.lazy = FALSE,
                      tidy = "styler")
options(tinytex.engine = "xelatex")
```

# Preparations

## Load libraries

```{r}
#| label: libraries
#| output: false
#| eval: true
#| warning: false
#| message: false
#| cache: false

library(tidyverse)   #for data wrangling
library(readxl)
library(vegan)
library(stringr)
library(car)
library(brms)
library(patchwork)
library(corrplot)
library(loo)
library(tidybayes)
library(DHARMa)     #for residual diagnostics
library(rstan)      #for interfacing with STAN
library(emmeans)
library(bayestestR)
library(ggridges) 

source('../R/functions.R')
knitr::read_chunk('../R/data_analysis.R')
```

## Load data

```{r}
#| label: loadData

recruit <- read_csv(file = '../data/processed/recruit.csv', col_select = -1)
```

Quick view of dataset:

::: panel-tabset
## Top rows

```{r}
recruit |> 
  head()
```

## Structure

```{r}
recruit |>
  str()
```
:::

```{r}
recruit <- recruit |>
  mutate(Treatment = factor(Treatment),
         Grazing = factor(Grazing, c('No', 'Light', 'Medium', 'Heavy'), ordered = TRUE))
```

# Exploratory data analysis

::: panel-tabset
## By Treatment

```{r}
#| fig-width: 8
#| fig-height: 5
#| echo: false

recruit |> 
  ggplot(aes(y = Total, x = Treatment)) +
  geom_violin() +
  geom_point(color = 'black') + 
  theme_classic() +
  theme(text = element_text(colour = 'black'), 
        axis.text = element_text(size = rel(1.2)),
        axis.title = element_text(size = rel(1.5)),
        legend.text = element_text(size = rel(1.2)),
        legend.title = element_text(size = rel(1.5))) +
  scale_y_continuous(name = 'Total recruits', n.breaks = 3)
```

## Scatterplot

```{r}
#| echo: false
#| warning: false
#| fig-width: 10
#| fig-height: 10
scatterplotMatrix(~Total+H_mean_broad+Freq_Sarg_broad+H_mean_local+Freq_Sarg_local+D_broad+R_broad_alg+R_broad_coral+R_local_alg+R_local_coral+Shannon_broad_alg+Shannon_broad_cor+Shannon_local_alg+Shannon_local_cor+Tot_broad_alg+Tot_broad_coral+Tot_local_alg+Tot_local_coral, 
                  data = recruit, diagonal = list(method = 'boxplot'))
```

## Correlation

```{r}
#| echo: false
#| fig-width: 10
#| fig-height: 10
recruit |> 
  dplyr::select(H_mean_broad, Freq_Sarg_broad, H_mean_local, Freq_Sarg_local, D_broad, R_broad_alg, R_broad_coral, R_local_alg, R_local_coral, Shannon_broad_alg, Shannon_broad_cor, Shannon_local_alg, Shannon_local_cor, Tot_broad_alg, Tot_broad_coral, Tot_local_alg, Tot_local_coral) |> cor() |> corrplot()
```


## Grazing
```{r}
ggplot(recruit, aes(x = Grazing, fill = Treatment)) + 
  geom_bar(position = "stack")
```


:::

# Model 1 - Recruits \~ Treatment

Model formula:

$$
\begin{align}
y_i &\sim{} \mathcal{Pois}(\lambda_i)\\
ln(\mu_i) &= \boldsymbol{\beta} \bf{X_i}\\
\beta_0 &\sim{} \mathcal{N}(0.5, 5)\\
\beta_{1,2,3} &\sim{} \mathcal{N}(0,10)\\
\end{align}
$$

## Model investigation

### Output

```{r}
#| label: M1Output
#| eval: false
```

```{r}
#| echo: false
read.delim(file = '../output/tables/M1Output.txt', sep = ',')
```

The intercept is 'All algae'. For example, 'No algae' has 2.9x (290%) more recruits than 'All algae'.

### Contrasts

```{r}
#| label: M1Contrast
#| eval: false
```

```{r}
#| echo: false
read.delim(file = '../output/tables/M1Contrast.txt', sep = ',')
```

Using ROPE (region of practical equivalents), we also couldn't establish if any groups were the same. So apart for Only mat/No algae and Only mat/Only canopy which are statistically different, the others were not different but there's also not enough evidence to say that they're the same.

### Summary figure

![](../output/figures/M1ContrastFig.png)

## Planned contrasts

We're going to compare specific groups:

1.  No algae/Only mat vs All algae/Only canopy
2.  No algae vs Any algae

To find the groups:

|             | Mat vs Canopy | No algae vs Any algae | Mat vs Any algae |
|-------------|---------------|-----------------------|------------------|
| All algae   | -1/2          | -1/3                  | -1/2             |
| No algae    | 1/2           | 1                     | 0                |
| Only canopy | -1/2          | -1/3                  | -1/2             |
| Only mat    | 1/2           | -1/3                  | 1                |

```{r}
#| label: PlannedContrast
#| eval: false
```

```{r}
#| echo: false
read.delim(file = '../output/tables/M1PlannedContrast.txt', sep = ',')
```


# M2-3: Recruits \~ *Sargassum* height

::: panel-tabset
## Model 2 - quadrats

Model formula:

$$
\begin{align}
y_i &\sim{} \mathcal{Pois}(\lambda_i)\\
ln(\mu_i) &= \boldsymbol{\beta} \bf{X_i}\\
\beta_0 &\sim{} \mathcal{N}(0.5, 10)\\
\beta_{1} &\sim{} \mathcal{N}(6,5)\\
\end{align}
$$

### Output

```{r}
#| label: M2Output
#| eval: false
```

```{r}
#| echo: false
read.delim(file = '../output/tables/M2Output.txt', sep = ',')
```

### Summary figure

![](../output/figures/M2Figure.png)

## Model 3 - perimeter

Model formula:

$$
\begin{align}
y_i &\sim{} \mathcal{Pois}(\lambda_i)\\
ln(\mu_i) &= \boldsymbol{\beta} \bf{X_i}\\
\beta_0 &\sim{} \mathcal{N}(0.5, 10)\\
\beta_{1} &\sim{} \mathcal{N}(6,8)\\
\end{align}
$$


### Output

```{r}
#| label: M3Output
#| eval: false
```

```{r}
#| echo: false
read.delim(file = '../output/tables/M3Output.txt', sep = ',')
```

### Summary figure

![](../output/figures/M3Figure.png)

:::


## Compare quadrat vs perimeter

```{r}
#| label: CompareM2vsM3
#| eval: false
```

There was no difference between the two models

# Model 4 - Recruits \~ *Sargassum* density

Model formula:

$$
\begin{align}
y_i &\sim{} \mathcal{Pois}(\lambda_i)\\
ln(\mu_i) &= \boldsymbol{\beta} \bf{X_i}\\
\beta_0 &\sim{} \mathcal{N}(0.5, 10)\\
\beta_{1} &\sim{} \mathcal{N}(1,3)\\
\end{align}
$$


## Output

```{r}
#| label: M4Output
#| eval: false
```

```{r}
#| echo: false
read.delim(file = '../output/tables/M4Output.txt', sep = ',')
```

## Summary figure

![](../output/figures/M4Figure.png)

# Model 7 - Recruits \~ Diversity (quadrats)

Model formula:

$$
\begin{align}
y_i &\sim{} \mathcal{Pois}(\lambda_i)\\
ln(\mu_i) &= \boldsymbol{\beta} \bf{X_i}\\
\beta_0 &\sim{} \mathcal{N}(0.5, 10)\\
\beta_{1,2} &\sim{} \mathcal{N}(1,2)\\
\end{align}
$$


## Output

```{r}
#| label: M7Output
#| eval: false
```

```{r}
#| echo: false
read.delim(file = '../output/tables/M7Output.txt', sep = ',')
```

## Summary figure

![](../output/figures/M7Figure.png)

# M12-13: Recruits \~ *Sargassum* cover

::: panel-tabset
## Model 12 - quadrats

Model formula:

$$
\begin{align}
y_i &\sim{} \mathcal{Pois}(\lambda_i)\\
ln(\mu_i) &= \boldsymbol{\beta} \bf{X_i}\\
\beta_0 &\sim{} \mathcal{N}(0.5, 10)\\
\beta_{1} &\sim{} \mathcal{N}(20, 30)\\
\end{align}
$$

### Output

```{r}
#| label: M12Output
#| eval: false
```

```{r}
#| echo: false
read.delim(file = '../output/tables/M12Output.txt', sep = ',')
```

### Summary figure

![](../output/figures/M12Figure.png)

## Model 13 - perimeter

Model formula:

$$
\begin{align}
y_i &\sim{} \mathcal{Pois}(\lambda_i)\\
ln(\mu_i) &= \boldsymbol{\beta} \bf{X_i}\\
\beta_0 &\sim{} \mathcal{N}(0.5, 10)\\
\beta_{1} &\sim{} \mathcal{N}(35, 45)\\
\end{align}
$$


### Output

```{r}
#| label: M13Output
#| eval: false
```

```{r}
#| echo: false
read.delim(file = '../output/tables/M13Output.txt', sep = ',')
```

### Summary figure

![](../output/figures/M13Figure.png)

:::


## Compare quadrat vs perimeter

```{r}
#| label: CompareM12vsM13
#| eval: false
```

There was no difference between the two models.


